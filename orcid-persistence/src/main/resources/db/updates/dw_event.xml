<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-2.0.xsd">

    <changeSet id="CREATE-DW-EVENT-VIEW-GROUP-BY-DAY-CLIENT_ID-AND-EVENT_TYPE" author="Daniel Palafox" dbms="postgresql">
        <preConditions onFail="MARK_RAN">
            <not><viewExists viewName="dw_event"/></not>
        </preConditions>
        <createView viewName="dw_event">
            SELECT event_type, client_id, COUNT(id), DATE_TRUNC('day', date_created)
            FROM event
            WHERE event_type != 'Public-Page'
            GROUP BY event_type, client_id, DATE_TRUNC('day', date_created)
            ORDER BY DATE_TRUNC('day', date_created) DESC;
        </createView>
    </changeSet>

    <changeSet id="GRANT-READ-TO-DW_USER-TO-DW_EVENT-VIEW" author="Daniel Palafox" dbms="postgresql">
        <preConditions>
            <sqlCheck expectedResult="1">SELECT 1 FROM pg_roles WHERE rolname='dw_user'</sqlCheck>
        </preConditions>
        <sql>GRANT SELECT ON TABLE dw_event to dw_user;</sql>
    </changeSet>

    <changeSet id="CREATE-DW-EVENT-VIEW-GROUP-BY-PUBLIC-PAGE" author="Daniel Palafox" dbms="postgresql">
        <preConditions onFail="MARK_RAN">
            <not><viewExists viewName="dw_event_public_page"/></not>
        </preConditions>
        <createView viewName="dw_event_public_page">
            SELECT event_type, public_page, COUNT(id), DATE_TRUNC('day', date_created)
            FROM event
            WHERE event_type = 'Public-Page'
            GROUP BY event_type, public_page, DATE_TRUNC('day', date_created)
            ORDER BY DATE_TRUNC('day', date_created) DESC;
        </createView>
    </changeSet>

    <changeSet id="GRANT-READ-TO-DW-EVENT-VIEW-GROUP-BY-PUBLIC-PAGE" author="Daniel Palafox" dbms="postgresql">
        <preConditions>
            <sqlCheck expectedResult="1">SELECT 1 FROM pg_roles WHERE rolname='dw_user'</sqlCheck>
        </preConditions>
        <sql>GRANT SELECT ON TABLE dw_event_public_page to dw_user;</sql>
    </changeSet>

</databaseChangeLog>
